{% extends 'base.html' %}

{% block title %}EvoPIE{% endblock %}

{% block head%}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">  
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
<script>
    $(document).ready( function () {
        $('#gradingtable').DataTable();
    } );
</script>
{% endblock %}

{% block content %}
<div class="jumbotron jumbotron-fluid">
    <div class="container">
        <h1 class="display-4">Quizzes Browser</h1>
            <p class="lead">
                These are the quizzes that you created. 
                You may edit them, grade them, or create new ones.
                You may also click on the title of any of the quizzes listed below to preview its description.
            </p>
    </div>
</div>



<div class="card bg-light m-3 mx-auto" style="width: 75%">
    <div class="card-body" bg-light>
        <h5 class="card-title" data-toggle = "collapse" data-target = "#newquiz">Compose new Quiz</h5>
        <div  id = "newquiz" class = "collapse">
        <p class="card-text">
            <form id='QuizForm'>
                <div class="form-group">
                    <label for="quiz_title">Title</label>
                    <input name="quiz_title" id="quiz_title" value="Your Quiz Title" required>
                </div>
                <div class="form-group">
                    <label for="quiz_description">Description</label>
                    <textarea class="summernote form-control" name="quiz_description" id="quiz_description" required></textarea>
                </div>
                <div class="form-group">
                    <label for="quiz_deadline0">Quiz Release Deadline</label>
                    <input type="datetime-local" id="quiz_deadline0" name="quiz_deadline0">
                </div>
                <div class="form-group">
                    <label for="quiz_deadline1">Step1 Submission Deadline</label>
                    <input type="datetime-local" id="quiz_deadline1" name="quiz_deadline1">
                </div>
                <div class="form-group">
                    <label for="quiz_deadline2">Step2 Submission Deadline</label>
                    <input type="datetime-local" id="quiz_deadline2" name="quiz_deadline2">
                </div>
                <div class="form-group">
                    <label for="quiz_deadline3">Solutions Release Deadline</label>
                    <input type="datetime-local" id="quiz_deadline3" name="quiz_deadline3">
                </div>
                <div class="form-group">
                    <label for="quiz_deadline4">Quiz Availability Deadline</label>
                    <input type="datetime-local" id="quiz_deadline4" name="quiz_deadline4">
                </div>
                <button onclick="submitQuizForm()" class="btn btn-primary">Submit</button>
            </form>
        </p>
        </div>
    </div>
</div>



<script type="text/javascript">
    function submitQuizForm(){
        let title = document.querySelector('#quiz_title');
        let description = document.querySelector('#quiz_description');
        let deadline0 = document.querySelector('#quiz_deadline0');
        let deadline1 = document.querySelector('#quiz_deadline1');
        let deadline2 = document.querySelector('#quiz_deadline2');
        let deadline3 = document.querySelector('#quiz_deadline3');
        let deadline4 = document.querySelector('#quiz_deadline4');

        
        let xhr = new XMLHttpRequest();
        let url = '/quizzes';
    
        xhr.open("POST", url, false);
        xhr.setRequestHeader("Content-Type", "application/json");

        // Create a state change callback 
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
               sendToFlashLand(this.responseText,"primary");
            }
        };

        // Converting JSON data to string 
        // old version limited to 3 questions
        // var data = JSON.stringify({ "title": title.value, "description": description.value, "questions_ids": [parseInt(qq1.value), parseInt(qq2.value), parseInt(qq3.value)] });
        
        var data = JSON.stringify({ "title": title.value, "description": description.value, "deadline0": deadline0.value, "deadline1": deadline1.value, "deadline2": deadline2.value, "deadline3": deadline3.value, "deadline4": deadline4.value });
        
        // Sending data with the request 
        xhr.send(data);
        event.preventDefault();
        //event.stopPropagation();
        location.reload();
        //return false;
    }
</script>



<div class="card bg-light m-3 mx-auto" style="width: 75%">
    
    <div class="card-body" bg-light>

        <table class='compact stripe' width='100%' id="gradingtable">
            <thead><tr>
                <th>ID</th>
                <th>Title</th>
                <th class="text-right text-end">Status</th>
                <th class="text-right text-end">Actions</th>
            </tr></thead>
            <tbody>
                    
            {% for single_quiz in all_quizzes %}
                <tr>
                    <td>
                        {{ single_quiz.id }}
                    </td>
                    <td>
                        <p data-toggle = "modal" data-target = "#q{{single_quiz.id}}">
                            {{ single_quiz.title }}
                        </p>
                        <div class="modal fade" id="q{{single_quiz.id}}" tabindex="-1" role="dialog"
                            aria-labelledby="mySmallModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                {{ single_quiz.description | safe }}
                            </div></div>
                        </div>
                    </td>
                    <td class='text-right text-end'>
                        <select id="status{{single_quiz.id}}">
                            <option value="HIDDEN"      {% if single_quiz.status == 'HIDDEN' %} selected {% endif %}>       Hidden</option>
                            <option value="STEP1"       {% if single_quiz.status == 'STEP1' %} selected {% endif %}>        Step #1</option>
                            <option value="STEP2"       {% if single_quiz.status == 'STEP2' %} selected {% endif %}>        Step #2</option>
                            <option value="SOLUTIONS"   {% if single_quiz.status == 'SOLUTIONS' %} selected {% endif %}>    Show Answers</option>
                        </select>
                    </td>
                    <td class='text-right text-end'>
                            <!svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-event" viewBox="0 0 16 16">
                                <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/>
                                <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                            <!/svg>
                        <a  href='{{url_for('pages.quiz_grader', qid=single_quiz.id)}}' type="button" class="">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-card-checklist" viewBox="0 0 16 16">
                                <path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"/>
                                <path d="M7 5.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm-1.496-.854a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 1 1 .708-.708l.146.147 1.146-1.147a.5.5 0 0 1 .708 0zM7 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm-1.496-.854a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 0 1 .708-.708l.146.147 1.146-1.147a.5.5 0 0 1 .708 0z"/>
                                </svg>
                        </a>
                        <a  href='{{url_for('pages.quiz_editor', quiz_id=single_quiz.id)}}' type="button" class="">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                                <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001zm-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708l-1.585-1.585z"/>
                            </svg>
                        </a>
                        <script>
                            document.querySelector('#status{{single_quiz.id}}').addEventListener('change',function(){
                                let target_url = '/quizzes/{{single_quiz.id}}/status';
                                let e = document.querySelector('#status{{single_quiz.id}}');
                                let selectedValue = e.options[e.selectedIndex].value;
                                fetch(target_url,{
                                    method:         'POST',
                                    headers:        {'Content-Type' : 'application/json'},
                                    body:           JSON.stringify({"status" :  selectedValue}),
                                    credentials:    'same-origin'
                                })
                                .then(
                                    response => {
                                        if(response.ok){
                                            sendToFlashLand("Quiz Status Updated","success");
                                            //window.location.reload();
                                        }else{
                                            sendToFlashLand("Quiz Status NOT Updated","danger");
                                            //window.location.reload();
                                        }
                                    }
                                )
                                .catch((error) => {
                                    sendToFlashLand("There was a problem updating the quiz status: " + error,"danger");
                                })
                            });
                        </script>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function deleteQuiz(quiz_id){
        let xhr = new XMLHttpRequest();
        let url = "/quizzes/" + quiz_id;
        
        xhr.open("DELETE", url, false);
        xhr.setRequestHeader("Content-Type", "application/json");

        // Create a state change callback 
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                sendToFlashLand(this.responseText,"primary");
            }
        };

        var data = JSON.stringify({});
        xhr.send(data);
        event.preventDefault();
        event.stopPropagation();
        location.reload();
        return false;
    }
</script>

{% endblock %}